<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ts-tooling Browser Tests</title>
</head>
<body>
<div id="mocha"></div>

<script src="https://unpkg.com/chai@4.1.2/chai.js"></script>
<script src="https://unpkg.com/mocha@4.0.1/mocha.js"></script>

<script>mocha.setup('bdd')</script>

<script src="../../lib/ts-tooling.js"></script>
<script type="application/javascript">
    describe('BackgroundWorker Tests', () => {
        it('run BackgroundWorker with external File', (done) => {
            const worker = new tst.BackgroundWorker('worker1.js');
            worker.OnError.subscribe(err => {
                console.error(err);
                chai.assert.fail('a Error was thrown in worker!');
            });
            worker.OnFinish.subscribe(d => {
                chai.assert.equal(d, 120);
                done();
            });
            worker.Run(5);
        });
        it('run multiple Workers', (done) => {
            var counter = 1;
            const worker1 = new tst.BackgroundWorker('worker1.js');
            worker1.OnFinish.subscribe((d) => {
                chai.assert.equal(d, 2.6525285981219103e+32);
                counter++;
                if (counter === 16) {
                    done();
                }
            });
            for (let i = 0; i < 16; i++) {
                worker1.Run(30);
            }
        });
        it('throws Error when empty worker path was given', () => {
            var worker = new tst.BackgroundWorker('');
            chai.assert.throws(() => {
                worker.Run();
            }, 'missing DoWork Path/File ');
        });
        it('throws Error when has no Typescript or Javascript endings', () => {
            var worker = new tst.BackgroundWorker('test.bash');
            chai.assert.throws(() => {
                worker.Run();
            }, 'test.bash is not supported Script for BackgroundWorker');
        });
    });

    describe("Test StopWatch", () => {
        it('can create the Stopwatch and measure the Time', (done) => {
            const sw = new tst.StopWatch();
            setTimeout(() => {
                chai.assert.isAbove(sw.ElapsedMs(), 0);
                done();
            }, 1);
        });

        it('can measure multiple Times', (done) => {
            const sw = new tst.StopWatch();
            sw.SectionStart('1');
            setTimeout(() => {
                chai.assert.isAbove(sw.SectionElapsedMs('1'), 0);
                done();
            }, 1);
        });

        it('nothing on select not existent Section elapsed', (done) => {
            const sw = new tst.StopWatch();
            setTimeout(() => {
                chai.assert.equal(sw.SectionElapsedMs('1'), 0);
                done();
            }, 1);
        });

        it('overwrite existing Section', (done) => {
            const sw = new tst.StopWatch();
            sw.SectionStart('1');
            setTimeout(() => {
                chai.assert.isAbove(sw.SectionElapsedMs('1'), 0);
                chai.assert.isBelow(sw.SectionElapsedMs('1'), 20);
                sw.SectionStart('1');
                setTimeout(() => {
                    chai.assert.isAbove(sw.SectionElapsedMs('1'), 8);
                    done();
                }, 10);
            }, 1);
        });

        it('make pause without resume', () => {
            const sw = new tst.StopWatch();
            chai.assert.isFalse(sw.IsPause);
            setTimeout(() => {
                sw.Pause();
                chai.assert.isTrue(sw.IsPause);
                setTimeout(() => {
                    chai.assert.isAbove(sw.ElapsedMs(), 9);
                    chai.assert.isBelow(sw.ElapsedMs(), 20);
                }, 10);
            }, 10);
        });

        it('make pause with resume', () => {
            const sw = new tst.StopWatch();
            chai.assert.isFalse(sw.IsPause);
            setTimeout(() => {
                sw.Pause();
                chai.assert.isTrue(sw.IsPause);
                setTimeout(() => {
                    sw.Resume();
                    chai.assert.isFalse(sw.IsPause);
                    setTimeout(() => {
                        chai.assert.isAbove(sw.ElapsedMs(), 19);
                        chai.assert.isBelow(sw.ElapsedMs(), 30);
                    }, 10);
                }, 10);
            }, 10);
        });

        it('make section pause without resume', () => {
            const sw = new tst.StopWatch();
            sw.SectionStart('1');
            chai.assert.isFalse(sw.IsSectionPause('1'));
            setTimeout(() => {
                sw.SectionPause('1');
                chai.assert.isTrue(sw.IsSectionPause('1'));
                setTimeout(() => {
                    chai.assert.isAbove(sw.SectionElapsedMs('1'), 9);
                    chai.assert.isBelow(sw.SectionElapsedMs('1'), 20);
                }, 10);
            }, 10);
        });

        it('make section pause with resume', () => {
            const sw = new tst.StopWatch();
            sw.SectionStart('1');
            chai.assert.isFalse(sw.IsSectionPause('1'));
            setTimeout(() => {
                sw.SectionPause('1');
                chai.assert.isTrue(sw.IsSectionPause('1'));
                setTimeout(() => {
                    sw.SectionResume('1');
                    chai.assert.isFalse(sw.IsSectionPause('1'));
                    setTimeout(() => {
                        chai.assert.isAbove(sw.SectionElapsedMs('1'), 19);
                        chai.assert.isBelow(sw.SectionElapsedMs('1'), 30);
                    }, 10);
                }, 10);
            }, 10);
        });
    });
</script>

<script>
    mocha.checkLeaks();
    mocha.run();
</script>
</body>
</html>
